{% extends 'tool.html' %}
{% load i18n static %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 16px;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .upload-area:hover {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .upload-area.dragover {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        transform: scale(1.02);
    }

    [data-theme="dark"] .upload-area {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border-color: #4b5563;
    }

    [data-theme="dark"] .upload-area:hover {
        border-color: #60a5fa;
        background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
    }

    [data-theme="dark"] .upload-area.dragover {
        border-color: #60a5fa;
        background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
    }

    .result-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    @media (max-width: 768px) {
        .result-container {
            grid-template-columns: 1fr;
        }
    }

    .image-preview {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .image-preview img {
        width: 100%;
        height: auto;
        display: block;
    }

    .checkerboard-bg {
        background-image:
            linear-gradient(45deg, #ccc 25%, transparent 25%),
            linear-gradient(-45deg, #ccc 25%, transparent 25%),
            linear-gradient(45deg, transparent 75%, #ccc 75%),
            linear-gradient(-45deg, transparent 75%, #ccc 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    [data-theme="dark"] .checkerboard-bg {
        background-image:
            linear-gradient(45deg, #374151 25%, transparent 25%),
            linear-gradient(-45deg, #374151 25%, transparent 25%),
            linear-gradient(45deg, transparent 75%, #374151 75%),
            linear-gradient(-45deg, transparent 75%, #374151 75%);
    }

    /* Toast notification styles */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .toast.hide {
        animation: slideOut 0.3s ease-in forwards;
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<!-- How It Works - Step Cards -->
<section class="mb-8">
    <div>
        <div class="text-center mb-6">
            <h2 class="text-xl font-bold text-base-content/80">{% trans "使用步骤" %}</h2>
            <p class="text-sm text-base-content/50 mt-1">{% trans "简单三步，快速移除背景" %}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Step 1 -->
        <div
            class="card bg-base-100 border border-base-300 hover:border-primary/50 hover:shadow-lg transition-all duration-300 group">
            <div class="card-body items-center text-center relative">
                <div
                    class="absolute -top-3 -left-3 w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm shadow-md">
                    1</div>
                <div
                    class="w-14 h-14 rounded-2xl bg-primary/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                    <img src="{% static 'toolbox/icons/upload.svg' %}" alt="step 1" class="h-7 w-7">
                </div>
                <h4 class="font-bold text-lg mb-2">{% trans "上传图片" %}</h4>
                <p class="text-sm text-base-content/60 leading-relaxed">{% trans "选择或拖放需要处理的图片，支持多种格式" %}</p>
            </div>
        </div>

        <!-- Step 2 -->
        <div
            class="card bg-base-100 border border-base-300 hover:border-primary/50 hover:shadow-lg transition-all duration-300 group">
            <div class="card-body items-center text-center relative">
                <div
                    class="absolute -top-3 -left-3 w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm shadow-md">
                    2</div>
                <div
                    class="w-14 h-14 rounded-2xl bg-primary/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                    <img src="{% static 'toolbox/icons/zap.svg' %}" alt="step 2" class="h-7 w-7">
                </div>
                <h4 class="font-bold text-lg mb-2">{% trans "自动处理" %}</h4>
                <p class="text-sm text-base-content/60 leading-relaxed">{% trans "AI 智能识别主体，自动移除背景" %}</p>
            </div>
        </div>

        <!-- Step 3 -->
        <div
            class="card bg-base-100 border border-base-300 hover:border-primary/50 hover:shadow-lg transition-all duration-300 group">
            <div class="card-body items-center text-center relative">
                <div
                    class="absolute -top-3 -left-3 w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm shadow-md">
                    3</div>
                <div
                    class="w-14 h-14 rounded-2xl bg-primary/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                    <img src="{% static 'toolbox/icons/download.svg' %}" alt="step 3" class="h-7 w-7">
                </div>
                <h4 class="font-bold text-lg mb-2">{% trans "下载结果" %}</h4>
                <p class="text-sm text-base-content/60 leading-relaxed">{% trans "获取透明背景的高质量 PNG 图片" %}</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Upload Section -->
<section class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-6 md:p-8">
        <!-- Upload Area -->
        <div id="upload-section" class="text-center">
            <div id="drop-zone" class="upload-area p-12 md:p-16 cursor-pointer relative"
                onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                <!-- Upload Icon -->
                <div class="mb-8">
                    <div class="w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
                        <img src="{% static 'toolbox/icons/image.svg' %}" alt="upload icon"
                            class="h-12 w-12 opacity-60">
                    </div>
                </div>

                <!-- Upload Text -->
                <h3 class="text-2xl font-bold mb-3 text-base-content">{% trans "拖放图片到这里" %}</h3>
                <p class="text-base-content/60 mb-6 text-lg">{% trans "或者点击上传图片" %}</p>

                <!-- Upload Button -->
                <button class="btn btn-primary btn-lg gap-2 shadow-lg hover:shadow-xl transition-shadow">
                    <img src="{% static 'toolbox/icons/upload.svg' %}" alt="upload" class="h-5 w-5 icon-mask">
                    {% trans "选择图片" %}
                </button>

                <!-- File Info -->
                <div class="mt-6 flex items-center justify-center gap-4 text-sm text-base-content/50">
                    <span class="flex items-center gap-1">
                        <img src="{% static 'toolbox/icons/file-image.svg' %}" alt="format" class="h-4 w-4">
                        JPG, PNG, WEBP
                    </span>
                    <span class="w-1 h-1 rounded-full bg-base-content/30"></span>
                    <span class="flex items-center gap-1">
                        <img src="{% static 'toolbox/icons/hard-drive.svg' %}" alt="size" class="h-4 w-4">
                        {% trans "最大 10MB" %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Processing State -->
        <div id="processing-section" class="hidden text-center py-16">
            <div class="relative inline-block mb-6">
                <div class="loading loading-spinner loading-lg text-primary w-16 h-16"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <img src="{% static 'toolbox/icons/image.svg' %}" alt="processing" class="h-6 w-6 opacity-40">
                </div>
            </div>
            <h3 class="text-2xl font-bold mb-3">{% trans "正在处理中..." %}</h3>
            <p class="text-base-content/60 text-lg">{% trans "AI 正在移除背景，请稍候" %}</p>
            <div class="mt-6 max-w-xs mx-auto">
                <progress class="progress progress-primary w-full"></progress>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="hidden">
            <!-- Result Header -->
            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 pb-4 border-b border-base-300">
                <div>
                    <h3 class="text-2xl font-bold">{% trans "处理完成" %}</h3>
                    <p class="text-base-content/60 text-sm mt-1">{% trans "背景已成功移除" %}</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-ghost gap-2" onclick="resetUpload()">
                        <img src="{% static 'toolbox/icons/refresh-ccw.svg' %}" alt="reset" class="h-4 w-4">
                        {% trans "重新上传" %}
                    </button>
                    <a id="download-btn" href="#" download
                        class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-shadow">
                        <img src="{% static 'toolbox/icons/download.svg' %}" alt="download" class="h-4 w-4 icon-mask">
                        {% trans "下载结果" %}
                    </a>
                </div>
            </div>

            <!-- Image Comparison -->
            <div class="result-container">
                <!-- Original -->
                <!-- <div class="bg-base-200/50 border border-base-300"> -->
                    <div class="card-body p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <img src="{% static 'toolbox/icons/image.svg' %}" alt="original" class="h-4 w-4 opacity-60">
                            <h4 class="text-sm font-semibold text-base-content/70">{% trans "原始图片" %}</h4>
                        </div>
                        <div class="image-preview bg-base-100">
                            <img id="original-image" src="" alt="original">
                        </div>
                    </div>
                <!-- </div> -->

                <!-- Result -->
                <!-- <div class="card bg-base-200/50 border border-base-300"> -->
                    <div class="card-body p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <img src="{% static 'toolbox/icons/check-circle.svg' %}" alt="result"
                                class="h-4 w-4 text-success">
                            <h4 class="text-sm font-semibold text-base-content/70">{% trans "移除背景后" %}</h4>
                            <span class="badge badge-success badge-sm ml-auto">{% trans "透明背景" %}</span>
                        </div>
                        <div class="image-preview checkerboard-bg">
                            <img id="result-image" src="" alt="result">
                        </div>
                    </div>
                <!-- </div> -->
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    const dropZone = document.getElementById('drop-zone');
    const uploadSection = document.getElementById('upload-section');
    const processingSection = document.getElementById('processing-section');
    const resultSection = document.getElementById('result-section');
    const originalImage = document.getElementById('original-image');
    const resultImage = document.getElementById('result-image');
    const downloadBtn = document.getElementById('download-btn');
    const toastContainer = document.getElementById('toast-container');

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast alert alert-${type} shadow-lg`;

        const icons = {
            success: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            error: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
        };

        toast.innerHTML = `
            ${icons[type] || icons.info}
            <span>${message}</span>
            <button class="btn btn-ghost btn-xs btn-circle" onclick="this.parentElement.remove()">✕</button>
        `;

        toastContainer.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    });

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            processFile(file);
        }
    }

    function processFile(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showToast('{% trans "请选择图片文件" %}', 'warning');
            return;
        }

        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            showToast('{% trans "文件大小不能超过 10MB" %}', 'warning');
            return;
        }

        // Show original preview
        const reader = new FileReader();
        reader.onload = (e) => {
            originalImage.src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Switch to processing state
        uploadSection.classList.add('hidden');
        processingSection.classList.remove('hidden');

        // Create FormData
        const formData = new FormData();
        formData.append('image', file);

        // Send request to backend
        fetch('{% url "toolbox:removebg" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                processingSection.classList.add('hidden');
                resultSection.classList.remove('hidden');

                if (data.success) {
                    resultImage.src = data.result_url;
                    downloadBtn.href = data.result_url;
                    downloadBtn.download = 'removed-bg-' + file.name;
                    showToast(data.message || '{% trans "背景移除成功" %}', 'success');
                } else {
                    showToast(data.error || '{% trans "处理失败，请重试" %}', data.error_type || 'error');
                    resetUpload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                processingSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                showToast('{% trans "处理失败，请重试" %}', 'error');
            });
    }

    function resetUpload() {
        uploadSection.classList.remove('hidden');
        processingSection.classList.add('hidden');
        resultSection.classList.add('hidden');
        document.getElementById('file-input').value = '';
        originalImage.src = '';
        resultImage.src = '';
    }
</script>
{% endblock %}
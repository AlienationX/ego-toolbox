{% load i18n static django_htmx %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'zh-hans' }}" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Toolbox{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    {% htmx_script %}
    <link rel="stylesheet" href="{% static 'toolbox/css/light.css' %}">
    <link rel="stylesheet" href="{% static 'toolbox/css/dark.css' %}">

    <!-- logoËÆæÁΩÆ -->
    <link rel="icon" href="{% static 'toolbox/logo.svg' %}">
    {% block extra_css %}{% endblock %}
    <script>
        (function () {
            const saved = localStorage.getItem('theme');
            const preferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', saved || preferred);
        })();
    </script>
</head>
<body class="min-h-screen bg-base-200 flex flex-col" hx-headers='{"x-csrftoken": "{{ csrf_token }}"}'>
    {% get_current_language as CURRENT_LANGUAGE %}
    {% get_available_languages as AVAILABLE_LANGUAGES %}
    {% get_language_info_list for AVAILABLE_LANGUAGES as LANGUAGES_INFO %}

    <header class="sticky top-0 z-40 border-b border-base-300 bg-base-100/85 backdrop-blur">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <div class="dropdown dropdown-bottom lg:hidden">
                    <button tabindex="0" class="btn btn-sm btn-ghost btn-circle border border-base-300" title="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 6h16v2H4V6Zm0 5h16v2H4v-2Zm0 5h16v2H4v-2Z"/>
                        </svg>
                    </button>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 border border-base-300 rounded-box w-72 z-50">
                        {% for group in nav_categories %}
                        <li>
                            <details>
                                <summary>{{ group.label }}</summary>
                                <ul>
                                    {% for tool in group.tools %}
                                    <li>
                                        {% if tool.url %}
                                        <a href="{{ tool.url }}">{{ tool.title }}</a>
                                        {% else %}
                                        <span class="opacity-60 cursor-default">{{ tool.title }}</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </details>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <a href="{% url 'toolbox:index' %}" class="btn btn-ghost px-2 text-xl font-semibold normal-case shrink-0">
                    <span class="text-primary">Ego</span>
                    <span>Toolbox</span>
                </a>

                <nav class="navbar hidden lg:flex min-h-0 p-0 items-center gap-1">
                    {% for group in nav_categories %}
                    <div class="dropdown dropdown-hover dropdown-bottom group">
                        <button tabindex="0" class="btn btn-sm btn-ghost rounded-full gap-1">
                            <span>{{ group.label }}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 transition-transform duration-200 group-hover:rotate-180">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.167l3.71-3.938a.75.75 0 1 1 1.08 1.04l-4.25 4.5a.75.75 0 0 1-1.08 0l-4.25-4.5a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 border border-base-300 rounded-box min-w-56 max-w-80 w-max z-50">
                            {% for tool in group.tools %}
                            <li>
                                {% if tool.url %}
                                <a href="{{ tool.url }}">{{ tool.title }}</a>
                                {% else %}
                                <span class="opacity-60 cursor-default">{{ tool.title }}</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </nav>
            </div>

            <div class="flex items-center gap-2 shrink-0">
                <a href="{% url 'my_login' %}" class="btn btn-sm btn-primary rounded-full px-4">{% trans "ÁôªÂΩï" %}</a>

                <button id="theme-toggle" class="btn btn-sm btn-ghost btn-circle border border-base-300" type="button" title="Theme">
                    <span id="theme-icon" aria-hidden="true">‚òÄÔ∏è</span>
                </button>

                {% for lang in LANGUAGES_INFO %}
                    {% if lang.code|slice:":2" != CURRENT_LANGUAGE|slice:":2" %}
                    <form method="post" action="{% url 'set_language' %}" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="language" value="{{ lang.code }}">
                        <button type="submit" class="btn btn-sm btn-ghost rounded-full border border-base-300 px-3" title="Language">
                            <span aria-hidden="true">üåê</span>
                            <span>
                                {% if lang.code|slice:":2" == "en" %}
                                    EN
                                {% elif lang.code|slice:":2" == "zh" %}
                                    ‰∏≠Êñá
                                {% else %}
                                    {{ lang.name_local }}
                                {% endif %}
                            </span>
                        </button>
                    </form>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 md:py-8 flex-1">
        {% block content %}{% endblock %}
    </main>

    <footer class="border-t border-base-300 py-6 bg-base-100/70">
        <div class="container mx-auto px-4 text-sm text-base-content/60 flex flex-col md:flex-row gap-2 md:items-center md:justify-between">
            <span>¬© {% now "Y" %} Ego Toolbox</span>
            <span>{% trans "Êõ¥Âø´„ÄÅÊõ¥‰ºòÈõÖ„ÄÅÊõ¥ÂÆûÁî®ÁöÑÂú®Á∫øÂ∑•ÂÖ∑ÈõÜÂêà„ÄÇ" %}</span>
        </div>
    </footer>

    {% block extra_js %}{% endblock %}
    <script>
        (function () {
            const html = document.documentElement;
            const toggle = document.getElementById('theme-toggle');
            const icon = document.getElementById('theme-icon');
            if (!toggle) return;

            function syncThemeIcon() {
                const current = html.getAttribute('data-theme') || 'light';
                if (icon) {
                    icon.textContent = current === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                }
            }

            syncThemeIcon();
            toggle.addEventListener('click', function () {
                const current = html.getAttribute('data-theme') || 'light';
                const next = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                syncThemeIcon();
            });
        })();
    </script>
</body>
</html>
